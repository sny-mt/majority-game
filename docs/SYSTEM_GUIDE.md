# マジョリティゲーム システムガイド
## 〜プログラムがわからない人でも理解できる解説〜

---

## はじめに

このドキュメントは、プログラミングの知識がなくても「マジョリティゲーム」の仕組みが理解できるように書かれています。

専門用語が出てきた場合は、できるだけ日常の例えを使って説明します。

---

## 1. 全体像

### 1.1 このアプリは何をするもの？

**マジョリティゲーム**は、「みんなの多数派を当てる」パーティゲームです。

```
例えば...
お題: 「朝食はパン派？ごはん派？」

→ 10人中7人が「パン」と回答
→ 「パン」がマジョリティ（多数派）
→ 「パン」を予想した人がポイントゲット！
```

### 1.2 どうやって動いている？

```
┌──────────┐        インターネット        ┌──────────┐
│ あなたの │  ◀─────────────────────▶  │ データを │
│ スマホ   │                            │ 保存する │
│          │                            │ 場所     │
└──────────┘                            └──────────┘
   ブラウザ                               サーバー
  (Next.js)                             (Supabase)
```

**ブラウザ（スマホやPC）**
- 画面を表示する
- ボタンを押したときの動作
- アニメーションや紙吹雪

**サーバー（Supabase）**
- ルーム情報を保存
- 参加者リストを管理
- 回答を記録
- 「誰かが参加した」などをリアルタイム通知

---

## 2. データの保存場所

### 2.1 4つの引き出し（テーブル）

データは4つの「引き出し」に分けて保存されています。

```
┌─────────────────────────────────────────────────────┐
│                    データベース                      │
│                                                     │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐│
│   │ rooms   │  │questions│  │ players │  │ answers ││
│   │ ルーム  │  │ 質問    │  │参加者   │  │ 回答    ││
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘│
└─────────────────────────────────────────────────────┘
```

### 2.2 各引き出しの中身

#### 🏠 rooms（ルーム）
「ゲームの部屋」の情報を保存。

| 何を保存？ | 例 |
|-----------|-----|
| ルームID | abc-123-xyz |
| ルーム名 | 新年会ゲーム |
| 状態 | waiting / answering / finished |
| 今何問目？ | 3 |
| 主催者は誰？ | player-456 |

**状態（ステータス）の種類：**
- `waiting` = 参加者を待っている
- `answering` = 回答受付中
- `showing_result` = 結果発表中
- `finished` = ゲーム終了

#### ❓ questions（質問）
「お題」の情報を保存。

| 何を保存？ | 例 |
|-----------|-----|
| 質問ID | q-789 |
| どのルーム？ | abc-123-xyz |
| 質問文 | 好きな季節は？ |
| 選択肢A | 春 |
| 選択肢B | 秋 |
| 何番目？ | 1 |

#### 👤 players（参加者）
「誰が参加しているか」を保存。

| 何を保存？ | 例 |
|-----------|-----|
| プレイヤーID | player-456 |
| どのルーム？ | abc-123-xyz |
| ニックネーム | たろう |
| 主催者？ | はい / いいえ |
| 合計スコア | 35 |

#### ✍️ answers（回答）
「誰が何と答えたか」を保存。

| 何を保存？ | 例 |
|-----------|-----|
| 回答ID | ans-001 |
| どの質問？ | q-789 |
| 誰の回答？ | player-456 |
| 回答 | A（春） |
| 予想 | A（春） |
| コメント | 桜が好きだから |
| 予想当たった？ | はい |
| 獲得ポイント | 10 |

---

## 3. 画面ごとの動き

### 3.1 ホーム画面（トップページ）

**何ができる？**
- ゲームのルームを作る
- 過去に作ったルームの質問を再利用

**裏で起きていること：**

```
┌─────────────────────────────────────────────────────┐
│ 1. 画面を開いたとき                                  │
├─────────────────────────────────────────────────────┤
│                                                     │
│   あなたのスマホ               サーバー              │
│        │                         │                 │
│        │──「自分のIDある？」────▶│                 │
│        │                         │                 │
│        │   なければ新しく作る     │                 │
│        │   (abc-def-123みたいな)  │                 │
│        │                         │                 │
│        │──「過去のルーム教えて」─▶│                 │
│        │◀─「これだよ」───────────│                 │
│        │                         │                 │
└─────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────┐
│ 2. 「ルームを作成」ボタンを押したとき                 │
├─────────────────────────────────────────────────────┤
│                                                     │
│   あなたのスマホ               サーバー              │
│        │                         │                 │
│        │──「新しいルーム作って」─▶│                 │
│        │   名前: 新年会ゲーム      │                 │
│        │   質問: 好きな季節は？    │                 │
│        │                         │                 │
│        │◀─「できたよ！ID:xyz」───│                 │
│        │                         │                 │
│   QRコードとURLを表示             │                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 3.2 参加画面

**何ができる？**
- QRコードやURLからアクセスした人が名前を入れて参加

**裏で起きていること：**

```
┌─────────────────────────────────────────────────────┐
│ 1. 画面を開いたとき                                  │
├─────────────────────────────────────────────────────┤
│                                                     │
│   参加者のスマホ               サーバー              │
│        │                         │                 │
│        │──「ルームxyz存在する？」▶│                 │
│        │◀─「あるよ！」───────────│                 │
│        │                         │                 │
│   ニックネーム入力欄を表示        │                 │
│                                                     │
│   ※ルームがない場合は            │                 │
│   「見つかりません」と表示        │                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────┐
│ 2. 「参加する」ボタンを押したとき                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│   参加者のスマホ               サーバー              │
│        │                         │                 │
│        │──「たろうで参加したい」─▶│                 │
│        │                         │                 │
│        │   サーバーが確認:        │                 │
│        │   ・名前OK？ ✓           │                 │
│        │   ・もう参加してない？   │                 │
│        │                         │                 │
│        │◀─「登録したよ！」───────│                 │
│        │                         │                 │
│   待機画面に移動                  │                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 3.3 待機画面

**何ができる？**
- 参加者が揃うのを待つ
- QRコードを見せて招待
- 遊び方を確認
- 主催者はゲームを開始できる

**裏で起きていること（リアルタイム通知）：**

```
┌─────────────────────────────────────────────────────┐
│ 誰かが参加したとき                                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│   全員のスマホ                 サーバー              │
│        │                         │                 │
│        │   （監視中...）          │                 │
│        │                         │                 │
│        │                         │ ← 新しい人が    │
│        │                         │   参加！        │
│        │                         │                 │
│        │◀─「はなこが参加したよ」─│                 │
│        │                         │                 │
│   参加者リストが自動更新！        │                 │
│   （ページ更新不要）              │                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**ポイント：リアルタイム通知とは？**

普通のWebサイトは「更新ボタン」を押さないと新しい情報が見れません。
でもこのアプリは、サーバーから「変化があったよ！」と教えてもらえるので、
自動で画面が更新されます。LINEの通知みたいなイメージです。

---

### 3.4 回答画面

**何ができる？**
- お題に対して回答を選ぶ（A or B or 自由記述）
- 「多数派はどっち？」を予想
- コメントを書く

**裏で起きていること：**

```
┌─────────────────────────────────────────────────────┐
│ 回答を送信したとき                                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│   あなたのスマホ               サーバー              │
│        │                         │                 │
│        │──「回答を保存して」────▶│                 │
│        │   回答: A（春）          │                 │
│        │   予想: A               │                 │
│        │   コメント: 桜が好き     │                 │
│        │                         │                 │
│        │◀─「保存したよ！」───────│                 │
│        │                         │                 │
│   紙吹雪が出る 🎊                 │                 │
│   「回答済み」表示に変わる        │                 │
│                                                     │
│        │                         │                 │
│        │   他の人の画面にも      │                 │
│        │   「回答済み: 3/5」が   │                 │
│        │   リアルタイム更新      │                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 3.5 結果画面

**何ができる？**
- マジョリティ（多数派）が何だったか見る
- 自分の予想が当たったか確認
- 現在のランキングを見る

**裏で起きていること（ポイント計算）：**

```
┌─────────────────────────────────────────────────────┐
│ ポイント計算の仕組み                                 │
├─────────────────────────────────────────────────────┤
│                                                     │
│   【基本ルール】                                     │
│   ・予想が当たったら → +10ポイント                   │
│                                                     │
│   【シンクロボーナス】                               │
│   ・自由記述で他の人と完全に同じ答えなら             │
│     → 一致した人数 × 5ポイント                      │
│                                                     │
│   例）3人が「カレー」と書いた場合                    │
│       → 3人それぞれ +15ポイント（3×5）              │
│                                                     │
└─────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────┐
│ 画面を開いたとき（最初の1人だけが計算実行）          │
├─────────────────────────────────────────────────────┤
│                                                     │
│   あなたのスマホ               サーバー              │
│        │                         │                 │
│        │──「結果を教えて」──────▶│                 │
│        │                         │                 │
│        │                         │ 計算中...       │
│        │                         │ ・マジョリティ  │
│        │                         │   は何？        │
│        │                         │ ・予想当たった  │
│        │                         │   人は？        │
│        │                         │ ・ポイント計算  │
│        │                         │                 │
│        │◀─「結果だよ」───────────│                 │
│        │                         │                 │
│   マジョリティ発表！              │                 │
│   当たってたら紙吹雪 🎊           │                 │
│   外れてたら画面がブルブル 📳     │                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 3.6 最終結果画面

**何ができる？**
- 最終順位を見る
- 全問の結果を振り返る
- 結果を画像で保存

**表示される内容：**

```
┌─────────────────────────────────────────────────────┐
│               🏆 最終結果 🏆                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│   🥇 1位  たろう      45pt                          │
│   🥈 2位  はなこ      35pt                          │
│   🥉 3位  じろう      30pt                          │
│      4位  さぶろう    20pt                          │
│      5位  しろう      15pt                          │
│                                                     │
├─────────────────────────────────────────────────────┤
│   📋 全問の結果                                     │
│                                                     │
│   Q1. 好きな季節は？                                │
│       マジョリティ: 春（6人）                       │
│                                                     │
│   Q2. 朝食はパン派？ごはん派？                      │
│       マジョリティ: パン（5人）                     │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 4. 仕組みの詳細

### 4.1 プレイヤーIDの管理

**Q. なぜ「プレイヤーID」が必要？**

ログインなしで遊べるようにするためです。
代わりに、スマホの中（ブラウザ）にIDを保存しておきます。

```
┌─────────────────────────────────────────────────────┐
│ 初めてアプリを開いたとき                             │
├─────────────────────────────────────────────────────┤
│                                                     │
│   1. 「このスマホのIDある？」をチェック              │
│                                                     │
│   2. ない！→ 新しく作る                             │
│      「abc-123-xyz-789」みたいなランダム文字列      │
│                                                     │
│   3. スマホの中に保存（localStorage）               │
│      ※アプリを閉じても残る                         │
│      ※ブラウザのデータを消すと消える               │
│                                                     │
│   4. 次からはこのIDを使って「同じ人」と識別          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 4.2 リアルタイム通知の仕組み

**Q. どうやって「誰かが参加した」がすぐわかる？**

Supabaseの「Realtime」という機能を使っています。

```
┌─────────────────────────────────────────────────────┐
│ イメージ: グループLINEの通知                         │
├─────────────────────────────────────────────────────┤
│                                                     │
│   【普通のWebサイト】                                │
│   ・更新ボタンを押さないと新情報が見れない          │
│   ・例: ニュースサイト                              │
│                                                     │
│   【このアプリ】                                     │
│   ・サーバーから「変化があったよ！」と通知が来る    │
│   ・自動で画面が更新される                          │
│   ・例: LINEの新着メッセージ通知                    │
│                                                     │
│   具体的には...                                     │
│   ・「参加者が増えた」→ 参加者リスト更新            │
│   ・「回答が増えた」→ 回答数カウント更新            │
│   ・「ゲーム開始された」→ 回答画面に自動遷移        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 4.3 セキュリティ対策

**Q. 悪意のある入力を防ぐには？**

全ての入力は「消毒（サニタイズ）」してから使います。

```
┌─────────────────────────────────────────────────────┐
│ 入力値の処理                                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│   ユーザーが入力: 「<script>悪いコード</script>」   │
│                     ↓                              │
│   サニタイズ後:   「&lt;script&gt;...」             │
│                   （無害な文字に変換）              │
│                                                     │
│   さらに...                                         │
│   ・文字数制限（長すぎる入力を防ぐ）                │
│   ・空白の除去（前後のスペースを削除）              │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 5. 画面の演出

### 5.1 紙吹雪（Confetti）

**いつ出る？**
- 回答を送信したとき（小さめ）
- 予想が的中したとき（派手に）
- 最終結果画面を開いたとき（金色）

**仕組み:**
canvas-confettiというライブラリを使用。
画面上に小さな紙切れを描画して、落下アニメーション。

### 5.2 画面シェイク

**いつ起きる？**
- 予想が外れたとき（1秒間、左右に揺れる）

**仕組み:**
CSSアニメーションで画面全体を左右に動かす。

```
ブルブル → ← → ← （0.5秒を2回繰り返し）
```

### 5.3 カウントアップアニメーション

**どこで使う？**
- 結果画面の投票数表示
- ランキングのポイント表示

**仕組み:**
0から目標の数字まで、徐々に増やしていく。
最初は速く、最後はゆっくり（イージング）。

```
0 → 15 → 28 → 38 → 44 → 48 → 50（目標）
（速い）              （ゆっくり）
```

---

## 6. よくある質問

### Q1. 同じ人が2回参加できちゃう？

**A.** できません。プレイヤーIDで管理しているので、
同じブラウザからは1人として扱われます。

ただし、別のブラウザや別のスマホからなら、
別人として参加できてしまいます。
（これはログイン機能がないための制限）

### Q2. 途中でアプリを閉じたらどうなる？

**A.** 大丈夫！データはサーバーに保存されています。
同じURLを開けば、続きから参加できます。

### Q3. 主催者が途中で抜けたらどうなる？

**A.** ゲームが止まってしまいます。
主催者だけが「次の質問へ」「結果を見る」を操作できるため。

### Q4. 何人まで参加できる？

**A.** 技術的な制限はありませんが、
10〜20人程度が快適に遊べる想定です。
あまり多いと結果画面が見づらくなります。

### Q5. スマホとPCで見た目が違う？

**A.** 基本的に同じですが、画面サイズに合わせて
レイアウトが調整されます（レスポンシブデザイン）。

---

## 7. 用語集

| 用語 | 意味 |
|------|------|
| ブラウザ | WebサイトやWebアプリを見るソフト（Chrome、Safariなど） |
| サーバー | データを保存・管理するコンピュータ |
| データベース | データを整理して保存する場所 |
| テーブル | データを入れる「引き出し」のようなもの |
| リアルタイム | 即座に、待ち時間なく |
| localStorage | ブラウザ内にデータを保存する場所 |
| UUID | ランダムに生成される一意のID |
| サニタイズ | 危険な文字を無害化すること |
| イージング | 動きに緩急をつけること |
| レスポンシブ | 画面サイズに合わせてレイアウトが変わること |

---

## 8. 技術スタック（使っている道具）

| 何のため？ | 道具の名前 | 役割 |
|-----------|-----------|------|
| 画面を作る | Next.js | Webアプリの土台 |
| 見た目を整える | Material-UI | ボタンやフォームのデザイン |
| データを保存 | Supabase | データベース＋リアルタイム通知 |
| QRコード | qrcode.react | QRコード画像を生成 |
| 紙吹雪 | canvas-confetti | お祝いエフェクト |
| 公開する | Vercel | インターネットに公開 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-05 | 初版作成 |
